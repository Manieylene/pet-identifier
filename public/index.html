<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PAW-ID • Instant Pet Breed Identifier</title>

  <link rel="stylesheet" href="/styles.css">
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* --- RESULT CARD STYLES --- */
    .card {
      max-width: 420px;
      background: #fff;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      margin: 20px auto;
      font-family: Arial, sans-serif;
    }
    .hidden { display: none; }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom:12px; }
    .badge { padding: 6px 12px; border-radius: 999px; font-size: 12px; font-weight: bold; }
    .badge.pure { background: #e0f7ec; color: #0f7a4a; }
    .badge.mixed { background: #fff3cd; color: #856404; }
    .explanation { margin: 12px 0; font-size: 14px; color: #444; }
    .breed-row { margin-bottom: 10px; }
    .progress { height: 10px; background: #eee; border-radius: 10px; overflow: hidden; }
    .progress-bar { height: 100%; background: #4f46e5; }
    #confidenceChart { width: 100%; max-width: 100%; margin-top:12px; }
  </style>
</head>
<body>

<header>
  <div class="container header-inner">
    <div class="brand-left">
      <svg class="paw-logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
        <g fill="none" fill-rule="evenodd">
          <path d="M32 44c7 0 12.6-5.6 12.6-12.6S39 19 32 19s-12.6 5.6-12.6 12.6S25 44 32 44z" fill="#c49a6c"/>
          <path d="M20 18c2.2-4 6.6-6 10-4s4.9 6.6 2.7 10.6C29.7 26 25.7 24 20 18z" fill="#d9b68c" opacity="0.95"/>
          <path d="M46 18c-2.2-4-6.6-6-10-4s-4.9 6.6-2.7 10.6C38.3 26 42.3 24 46 18z" fill="#d9b68c" opacity="0.95"/>
          <path d="M11 30c0-3.3 2-7 4.3-8.6 2.5-1.8 5.8-.6 7.1 2.4 1.3 3 0 6-2.6 7.7C17 33 11 33.7 11 30z" fill="#d9b68c"/>
          <path d="M53 30c0-3.3-2-7-4.3-8.6-2.5-1.8-5.8-.6-7.1 2.4-1.3 3 0 6 2.6 7.7C47 33 53 33.7 53 30z" fill="#d9b68c"/>
        </g>
      </svg>

      <a class="brand" href="/">
        <span class="brand-title">PAW-ID</span>
        <span class="brand-sub">Instant Pet Breed Identifier</span>
      </a>
    </div>

    <nav>
      <ul id="navMenu">
        <li><a href="#home">Home</a></li>
        <li><a href="#detect">Detect PAW-ID</a></li>
      </ul>
    </nav>
  </div>
</header>

<section id="home" class="hero-wrap">
  <div class="hero-card centered-hero-card">
    <div class="hero-center">
      <h1>Welcome to PAW-ID System</h1>
      <p class="hero-sub">Snap a photo → get exact breed mix in 3 seconds<br>Works on dogs & cats • 350+ breeds • Mixed breeds too!</p>

      <div class="feature-grid-hero centered-cards">
        <div class="feature-card" id="cardCapture" data-action="capture" role="button" tabindex="0">
          <i class="fas fa-camera"></i>
          <h3>Capture Image</h3>
          <p>Use your device camera to capture your pet image.</p>
        </div>

        <div class="feature-card" id="cardUpload" data-action="upload" role="button" tabindex="0">
          <i class="fas fa-upload"></i>
          <h3>Upload Image</h3>
          <p>Upload an image from your gallery for analysis.</p>
        </div>
      </div>
    </div>
  </div>
</section>

<section id="detect" class="detection-section">
  <h2>Detect PAW-ID</h2>
  <p class="detect-sub">Select or capture an image of your pet for analysis:</p>

  <input type="file" id="imageInput" accept="image/*" style="display:none">

  <div class="image-preview-area">
    <p id="previewPlaceholder">No image selected</p>
    <img id="imagePreview" alt="Preview" style="display:none">
    <video id="videoPreview" autoplay playsinline style="display:none"></video>
    <button id="captureBtn" class="capture-btn" style="display:none"><i class="fas fa-circle"></i> Capture</button>
  </div>

  <button id="analyzeImageBtn" class="analyze-btn" disabled><i class="fas fa-search"></i> Analyze Image</button>
</section>

<!-- RESULT CARD -->
<div id="result-card" class="card hidden">
  <div class="card-header">
    <h2 id="main-breed">Breed</h2>
    <span id="badge" class="badge"></span>
  </div>

  <p id="explanation" class="explanation"></p>
  <div id="confidence-list"></div>
  <canvas id="confidenceChart" width="300" height="200"></canvas>
</div>

<script>
const cardCapture = document.getElementById('cardCapture');
const cardUpload = document.getElementById('cardUpload');
const imageInput = document.getElementById('imageInput');
const previewPlaceholder = document.getElementById('previewPlaceholder');
const imagePreview = document.getElementById('imagePreview');
const videoPreview = document.getElementById('videoPreview');
const captureBtn = document.getElementById('captureBtn');
const analyzeBtn = document.getElementById('analyzeImageBtn');

let stream = null;
let currentFile = null;

cardUpload.addEventListener('click', () => { stopCamera(); imageInput.click(); });
cardCapture.addEventListener('click', async () => { imageInput.value=''; await startCamera(); document.getElementById('detect').scrollIntoView({behavior:'smooth', block:'start'}); });
imageInput.addEventListener('change', (e) => { const f = e.target.files && e.target.files[0]; if(!f) return; setPreviewFromFile(f); stopCamera(); });

async function startCamera() {
  try { stream = await navigator.mediaDevices.getUserMedia({ video:{facingMode:"environment"}, audio:false }); } 
  catch(err){ stream = await navigator.mediaDevices.getUserMedia({ video:true, audio:false }); }
  videoPreview.srcObject = stream; videoPreview.style.display='block'; imagePreview.style.display='none';
  previewPlaceholder.style.display='none'; captureBtn.style.display='inline-flex'; analyzeBtn.disabled=true;
}

captureBtn.addEventListener('click', ()=>{
  if(!videoPreview.videoWidth) return;
  const canvas=document.createElement('canvas'); canvas.width=videoPreview.videoWidth; canvas.height=videoPreview.videoHeight;
  const ctx=canvas.getContext('2d'); ctx.drawImage(videoPreview,0,0,canvas.width,canvas.height);
  canvas.toBlob(blob=>{ const file=new File([blob],'capture.jpg',{type:'image/jpeg'}); setPreviewFromFile(file); stopCamera(); },'image/jpeg',0.9);
});

function setPreviewFromFile(file){
  currentFile=file;
  const reader=new FileReader();
  reader.onload=(ev)=>{
    imagePreview.src=ev.target.result; imagePreview.style.display='block';
    previewPlaceholder.style.display='none'; videoPreview.style.display='none'; captureBtn.style.display='none'; analyzeBtn.disabled=false;
  };
  reader.readAsDataURL(file);
}

function stopCamera(){ if(stream){stream.getTracks().forEach(t=>t.stop()); stream=null;} videoPreview.srcObject=null; videoPreview.style.display='none'; captureBtn.style.display='none'; }

// --- ANALYSIS ---
analyzeBtn.addEventListener('click', async ()=>{
  if(!currentFile){ alert('Select or capture an image first.'); return; }
  analyzeBtn.disabled=true; analyzeBtn.innerHTML='Analyzing...';
  try{
    const fd=new FormData(); fd.append('image',currentFile);
    const res=await fetch('/api/upload',{method:'POST',body:fd});
    if(!res.ok) throw new Error('Upload failed');
    const json=await res.json();
    renderResult(json);
  }catch(err){ console.error(err); alert('Analysis failed.'); }
  finally{ analyzeBtn.disabled=false; analyzeBtn.innerHTML='<i class="fas fa-search"></i> Analyze Image'; }
});

// --- RENDER RESULT CARD ---
function renderResult(data){
  const card=document.getElementById('result-card');
  const mainBreed=document.getElementById('main-breed');
  const badge=document.getElementById('badge');
  const explanation=document.getElementById('explanation');
  const list=document.getElementById('confidence-list');

  card.classList.remove('hidden');
  const breeds=data.mixedBreeds || [];
  const top=breeds[0] || {breed:'Unknown', confidence:'0%'};

  mainBreed.textContent=top.breed;

  if(breeds.length===1 || parseFloat(top.confidence)>80){
    badge.textContent='PURE / DOMINANT'; badge.className='badge pure';
    explanation.textContent=`The system detected a dominant ${top.breed} with high confidence, indicating a pure or visually dominant breed.`;
  } else{
    badge.textContent='MIXED BREED'; badge.className='badge mixed';
    explanation.textContent=`The system detected multiple breed features, suggesting a mixed-breed composition.`;
  }

  list.innerHTML='';
  breeds.forEach(b=>{
    const row=document.createElement('div'); row.className='breed-row';
    row.innerHTML=`<strong>${b.breed} (${b.confidence})</strong>
      <div class="progress"><div class="progress-bar" style="width:${b.confidence}"></div></div>`;
    list.appendChild(row);
  });

  drawChart(breeds);
}

function drawChart(breeds){
  const canvas=document.getElementById('confidenceChart');
  const ctx=canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width,canvas.height);
  const barWidth=40,gap=20,maxHeight=150; ctx.font='12px Arial'; ctx.textAlign='center';
  breeds.forEach((b,i)=>{
    const value=parseFloat(b.confidence); const height=(value/100)*maxHeight;
    const x=i*(barWidth+gap)+40; const y=canvas.height-height-20;
    ctx.fillStyle='#4f46e5'; ctx.fillRect(x,y,barWidth,height);
    ctx.fillStyle='#000'; ctx.fillText(b.breed,x+barWidth/2,canvas.height-5); ctx.fillText(b.confidence,x+barWidth/2,y-5);
  });
}

// Accessibility
[cardCapture,cardUpload].forEach(el=>{el.addEventListener('keydown',(e)=>{if(e.key==='Enter'||e.key===' ') el.click();});});
imagePreview.addEventListener('click',()=>{if(imagePreview.src) window.open(imagePreview.src,'_blank');});
</script>

</body>
</html>
