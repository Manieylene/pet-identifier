<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PAW-ID â€¢ Instant Pet Breed Identifier</title>

  <link rel="stylesheet" href="/styles.css">
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    .card {
      max-width: 420px;
      background: #fff;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      margin: 20px auto;
      font-family: Arial, sans-serif;
    }
    .hidden { display: none; }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom:12px;
    }
    .badge {
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: bold;
    }
    .badge.pure { background: #e0f7ec; color: #0f7a4a; }
    .badge.mixed { background: #fff3cd; color: #856404; }
    .explanation { margin: 12px 0; font-size: 14px; color: #444; }
    .breed-row { margin-bottom: 10px; }
    .progress { height: 10px; background: #eee; border-radius: 10px; overflow: hidden; }
    .progress-bar { height: 100%; background: #4f46e5; }
    #confidenceChart { width: 100%; margin-top:12px; }
  </style>
</head>

<body>

<section id="detect">
  <h2>Detect PAW-ID</h2>

  <input type="file" id="imageInput" accept="image/*" />

  <img id="imagePreview" style="max-width:300px; display:none; margin-top:10px" />

  <br><br>
  <button id="analyzeImageBtn" disabled>
    <i class="fas fa-search"></i> Analyze Image
  </button>
</section>

<div id="result-card" class="card hidden">
  <div class="card-header">
    <h2 id="main-breed">Breed</h2>
    <span id="badge" class="badge"></span>
  </div>
  <p id="explanation" class="explanation"></p>
  <div id="confidence-list"></div>
</div>

<script>
const imageInput = document.getElementById("imageInput");
const imagePreview = document.getElementById("imagePreview");
const analyzeBtn = document.getElementById("analyzeImageBtn");

let currentFile = null;

// PREVIEW IMAGE
imageInput.addEventListener("change", () => {
  const file = imageInput.files[0];
  if (!file) return;

  currentFile = file;
  const reader = new FileReader();

  reader.onload = e => {
    imagePreview.src = e.target.result;
    imagePreview.style.display = "block";
    analyzeBtn.disabled = false;
  };

  reader.readAsDataURL(file);
});

// SEND BASE64 IMAGE
analyzeBtn.addEventListener("click", async () => {
  if (!currentFile) return;

  analyzeBtn.disabled = true;
  analyzeBtn.innerText = "Analyzing...";

  try {
    const reader = new FileReader();

    reader.onload = async () => {
      const base64Image = reader.result;

      const res = await fetch("/api/upload", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ image: base64Image })
      });

      if (!res.ok) throw new Error("Upload failed");

      const data = await res.json();
      renderResult(data);
    };

    reader.readAsDataURL(currentFile);

  } catch (err) {
    alert("Analysis failed");
    console.error(err);
  } finally {
    analyzeBtn.disabled = false;
    analyzeBtn.innerHTML = '<i class="fas fa-search"></i> Analyze Image';
  }
});

// RENDER RESULT
function renderResult(data) {
  const card = document.getElementById("result-card");
  const mainBreed = document.getElementById("main-breed");
  const badge = document.getElementById("badge");
  const explanation = document.getElementById("explanation");
  const list = document.getElementById("confidence-list");

  card.classList.remove("hidden");
  list.innerHTML = "";

  const preds = data.predictions || [];

  if (!preds.length) {
    mainBreed.textContent = "Unknown";
    badge.textContent = "NO DATA";
    explanation.textContent = "No breed detected.";
    return;
  }

  const top = preds[0];
  mainBreed.textContent = top.class;
  badge.textContent = preds.length > 1 ? "MIXED BREED" : "PURE";
  badge.className = preds.length > 1 ? "badge mixed" : "badge pure";

  explanation.textContent = "Detected breed confidence levels:";

  preds.forEach(p => {
    const percent = (p.confidence * 100).toFixed(1);
    const row = document.createElement("div");
    row.className = "breed-row";
    row.innerHTML = `
      <strong>${p.class} (${percent}%)</strong>
      <div class="progress">
        <div class="progress-bar" style="width:${percent}%"></div>
      </div>
    `;
    list.appendChild(row);
  });
}
</script>

</body>
</html>
